# System Activity Logs Implementation Plan

## Overview
This document outlines a comprehensive plan for properly implementing system activity log messages throughout the AcciZard web application. The goal is to create a consistent, informative, and maintainable logging system that tracks all important user actions and system events.

## Current State Analysis

### Existing Log Structure
- **Collection**: `activityLogs` in Firestore
- **Current Fields**:
  - `admin` / `actor`: Name of the user performing the action
  - `actionType`: Type of action (login, edit, delete, create, permission, verification)
  - `action`: Description of the action
  - `timestamp`: When the action occurred

### Issues Identified
1. Inconsistent log message formats
2. Missing context in log messages
3. No standardized action types
4. Limited information about what was changed
5. No correlation between related actions

## Proposed Log Message Structure

### Standard Log Schema
```typescript
interface ActivityLog {
  id: string; // Auto-generated by Firestore
  userId: string; // Admin ID or Super Admin ID
  userName: string; // Display name
  userRole: 'admin' | 'superadmin';
  actionType: ActionType;
  action: string; // Human-readable description
  entityType?: string; // What was affected (e.g., 'report', 'admin', 'resident')
  entityId?: string; // ID of the affected entity
  entityName?: string; // Name of the affected entity (for display)
  changes?: Record<string, { from: any; to: any }>; // What changed
  metadata?: Record<string, any>; // Additional context
  timestamp: Timestamp | number;
  ipAddress?: string; // For security tracking
  userAgent?: string; // Browser/client info
}
```

### Action Types Enum
```typescript
enum ActionType {
  // Authentication
  LOGIN = 'login',
  LOGOUT = 'logout',
  LOGIN_FAILED = 'login_failed',
  
  // CRUD Operations
  CREATE = 'create',
  READ = 'read', // For sensitive data access
  UPDATE = 'update',
  DELETE = 'delete',
  
  // Admin Management
  ADMIN_CREATED = 'admin_created',
  ADMIN_UPDATED = 'admin_updated',
  ADMIN_DELETED = 'admin_deleted',
  ADMIN_PERMISSION_GRANTED = 'admin_permission_granted',
  ADMIN_PERMISSION_REVOKED = 'admin_permission_revoked',
  
  // Resident Management
  RESIDENT_CREATED = 'resident_created',
  RESIDENT_UPDATED = 'resident_updated',
  RESIDENT_DELETED = 'resident_deleted',
  RESIDENT_VERIFIED = 'resident_verified',
  RESIDENT_UNVERIFIED = 'resident_unverified',
  RESIDENT_SUSPENDED = 'resident_suspended',
  RESIDENT_UNSUSPENDED = 'resident_unsuspended',
  
  // Report Management
  REPORT_CREATED = 'report_created',
  REPORT_UPDATED = 'report_updated',
  REPORT_DELETED = 'report_deleted',
  REPORT_ADDED_TO_MAP = 'report_added_to_map',
  REPORT_REMOVED_FROM_MAP = 'report_removed_from_map',
  
  // Announcement Management
  ANNOUNCEMENT_CREATED = 'announcement_created',
  ANNOUNCEMENT_UPDATED = 'announcement_updated',
  ANNOUNCEMENT_DELETED = 'announcement_deleted',
  
  // Map/Pin Management
  PIN_CREATED = 'pin_created',
  PIN_UPDATED = 'pin_updated',
  PIN_DELETED = 'pin_deleted',
  PLACEMARK_ADDED = 'placemark_added',
  
  // System
  SYSTEM_SETTINGS_UPDATED = 'system_settings_updated',
  BULK_OPERATION = 'bulk_operation',
  DATA_EXPORTED = 'data_exported',
  DATA_IMPORTED = 'data_imported',
}
```

## Implementation Strategy

### Phase 1: Create Logging Utility Function
**File**: `src/lib/activityLogger.ts`

```typescript
import { collection, addDoc, serverTimestamp } from 'firebase/firestore';
import { db } from './firebase';
import { useUserRole } from '@/hooks/useUserRole';

interface LogOptions {
  actionType: ActionType;
  action: string;
  entityType?: string;
  entityId?: string;
  entityName?: string;
  changes?: Record<string, { from: any; to: any }>;
  metadata?: Record<string, any>;
}

export async function logActivity(options: LogOptions) {
  try {
    // Get current user info
    const userRole = await getCurrentUserRole(); // Helper function to get user role
    
    const logData = {
      userId: userRole.id,
      userName: userRole.name,
      userRole: userRole.userType,
      ...options,
      timestamp: serverTimestamp(),
      ipAddress: await getClientIP(), // Optional: Get from request headers
      userAgent: navigator.userAgent,
    };
    
    await addDoc(collection(db, 'activityLogs'), logData);
  } catch (error) {
    console.error('Failed to log activity:', error);
    // Don't throw - logging failures shouldn't break the app
  }
}
```

### Phase 2: Standardize Log Messages

#### Format Template
```
[Action] [EntityType] "[EntityName]" ([EntityId])
```

#### Examples:
- `Created admin account "John Doe" (AID-123)`
- `Updated resident "Jane Smith" (RID-456) - Changed status from "Pending" to "Verified"`
- `Deleted report "Fire Incident #789" (report-abc123)`
- `Granted edit permission to admin "John Doe" (AID-123)`
- `Verified resident "Jane Smith" (RID-456)`
- `Added report "Flood Alert" (report-xyz789) to map`
- `Bulk deleted 5 admin accounts`

### Phase 3: Integration Points

#### 1. Admin Management (`ManageUsersPage.tsx`)
- ✅ Admin created
- ✅ Admin updated
- ✅ Admin deleted
- ✅ Permission granted/revoked
- ✅ Bulk operations

#### 2. Resident Management (`ManageUsersPage.tsx`)
- ✅ Resident created
- ✅ Resident updated
- ✅ Resident deleted
- ✅ Verification status changed
- ✅ Suspension status changed
- ✅ Bulk operations

#### 3. Report Management (`ManageReportsPage.tsx`)
- ✅ Report created
- ✅ Report updated
- ✅ Report deleted
- ✅ Report added to map
- ✅ Patient information updated
- ✅ Dispatch form updated

#### 4. Announcement Management (`AnnouncementsPage.tsx`)
- ✅ Announcement created
- ✅ Announcement updated
- ✅ Announcement deleted

#### 5. Map Management (`RiskMapPage.tsx`)
- ✅ Pin created
- ✅ Pin updated
- ✅ Pin deleted
- ✅ Placemark added

#### 6. Authentication (`LoginForm.tsx`)
- ✅ Login successful
- ✅ Login failed
- ✅ Logout

### Phase 4: Enhanced Log Display

#### Improvements to `SystemLogsPage.tsx`:
1. **Better Filtering**:
   - Filter by entity type
   - Filter by date range
   - Filter by user role
   - Filter by action type

2. **Enhanced Details**:
   - Expandable rows showing full log details
   - Show changes (before/after values)
   - Show metadata
   - Show related entities

3. **Bulk Operations**:
   - Select multiple logs
   - Bulk delete (super admin only)
   - Export logs to CSV

4. **Search Improvements**:
   - Search by entity name
   - Search by entity ID
   - Search by log message

## Best Practices

### 1. Log Message Guidelines
- **Be Descriptive**: Include enough context to understand what happened
- **Be Consistent**: Use the same format for similar actions
- **Include IDs**: Always include entity IDs for traceability
- **Include Names**: Include human-readable names for better UX
- **Document Changes**: For updates, include what changed

### 2. Performance Considerations
- **Async Logging**: Don't block user actions waiting for logs
- **Batch Operations**: Log bulk operations as single entries with counts
- **Retention Policy**: Consider archiving old logs (older than 1 year)

### 3. Security Considerations
- **Don't Log Sensitive Data**: Never log passwords, tokens, or PII unnecessarily
- **IP Address Tracking**: Optional, useful for security audits
- **Access Control**: Only super admins can delete logs

### 4. Error Handling
- **Fail Silently**: Logging failures shouldn't break the app
- **Fallback**: If Firestore is unavailable, consider local storage fallback
- **Monitoring**: Alert if logging fails consistently

## Migration Plan

### Step 1: Create Utility Function
1. Create `src/lib/activityLogger.ts`
2. Implement `logActivity()` function
3. Add helper functions for getting user info

### Step 2: Update Existing Logs
1. Review all current logging locations
2. Replace with standardized `logActivity()` calls
3. Update log messages to follow format template

### Step 3: Add Missing Logs
1. Identify actions not currently logged
2. Add logging to all critical operations
3. Test logging functionality

### Step 4: Enhance UI
1. Update `SystemLogsPage.tsx` with new features
2. Add filters and search improvements
3. Add bulk operations

### Step 5: Documentation
1. Document logging standards for developers
2. Create examples for common scenarios
3. Update code review checklist

## Example Implementations

### Example 1: Admin Created
```typescript
await logActivity({
  actionType: ActionType.ADMIN_CREATED,
  action: `Created admin account "${newAdmin.name}" (${formattedUserId})`,
  entityType: 'admin',
  entityId: docRef.id,
  entityName: newAdmin.name,
  metadata: {
    position: newAdmin.position,
    username: newAdmin.username,
    hasEditPermission: false
  }
});
```

### Example 2: Resident Verified
```typescript
await logActivity({
  actionType: ActionType.RESIDENT_VERIFIED,
  action: `Verified resident "${resident.fullName}" (${resident.userId})`,
  entityType: 'resident',
  entityId: resident.id,
  entityName: resident.fullName,
  changes: {
    verified: { from: false, to: true }
  }
});
```

### Example 3: Report Updated
```typescript
await logActivity({
  actionType: ActionType.REPORT_UPDATED,
  action: `Updated report "${report.hazardType} Incident" (${report.reportId})`,
  entityType: 'report',
  entityId: report.id,
  entityName: `${report.hazardType} Incident`,
  changes: {
    status: { from: oldStatus, to: newStatus },
    // ... other changes
  }
});
```

## Success Metrics

1. **Coverage**: 100% of critical operations logged
2. **Consistency**: All logs follow standard format
3. **Performance**: Logging adds < 50ms to operations
4. **Usability**: Logs are searchable and filterable
5. **Maintainability**: Easy to add new log types

## Timeline

- **Week 1**: Create utility function and update existing logs
- **Week 2**: Add missing logs and enhance UI
- **Week 3**: Testing and documentation
- **Week 4**: Deployment and monitoring

## Notes

- Consider adding log retention policies (auto-delete logs older than X days)
- Consider adding log export functionality for compliance
- Consider adding real-time log monitoring dashboard
- Consider adding log analytics (most active users, most common actions, etc.)

